Surface Caching 是一种用于加速全局光照和反射计算的技术，主要思想是通过缓存表面上的光照和反射信息，以减少对这些信息的重复计算。这种方法特别适合于处理复杂的全局光照场景，例如动态光源、动态物体、以及间接光照较为密集的环境。Surface Caching 技术常用于实时渲染系统中，特别是在游戏引擎中，能够显著提升性能，减少光照计算开销。

# Surface Caching 的核心概念

1. 缓存光照信息：
   在场景中的每一个表面上，缓存上一次渲染时计算出的光照信息，例如直接光、间接光、反射光等。
   这些缓存的数据会在随后的帧中重复使用，除非场景中的光源、几何体或相机视角发生了显著变化。
   
2. 缓存结构：
   Surface Caching 通常会为场景中的不同区域或物体表面生成缓存。每个缓存结构保存该表面在不同方向上的光照和反射信息，类似于预计算辐射传输（Precomputed Radiance Transfer, PRT）技术。
   在现代图形处理管线中，缓存数据可以存储在纹理（Texture）或缓冲区（Buffer）中，以便快速读取和使用。

3. 光照插值和更新：
   缓存数据并不是每一帧都重新计算的。通常只在光源、物体或相机大幅度移动时，才会触发缓存的更新。否则会从之前计算的缓存数据中读取光照信息。
   当缓存需要更新时，可以通过插值算法平滑过渡，避免光照突然变化带来的视觉伪影。

4. 间接光照优化：
   Surface Caching 对间接光照的优化尤为明显。间接光照（即多次弹射的光线）通常计算开销巨大，而通过缓存间接光信息，可以大幅减少计算需求。
   在间接光照复杂的场景（如室内环境），通过缓存，可以有效减少实时光照计算的开销，避免每帧重复进行光线追踪或全局光照计算。

# Surface Caching 的应用场景

1. 动态全局光照：
   在动态场景中，全局光照（Global Illumination, GI）的计算往往是性能瓶颈。Surface Caching 可以在场景或物体保持相对稳定时缓存全局光照结果，避免在每一帧重新计算光线弹射和光照效果。
   动态物体的阴影、光照反射等信息也可以通过缓存机制加速更新，从而平衡全局光照的质量与性能。

2. 反射与环境光遮蔽：
   Surface Caching 对于反射和环境光遮蔽（Ambient Occlusion）的加速效果明显。通过缓存场景中不同表面上的反射光，特别是对高频率更新的镜面反射区域，能显著减少对反射光线的实时计算需求。
   同时，环境光遮蔽的计算结果也可以存入缓存，避免复杂场景中的频繁计算。

3. 大规模开放世界场景：
   在大型开放世界游戏中，光照计算往往需要处理海量的几何体和光线交互。Surface Caching 能够在较大场景区域内缓存静态光照结果，尤其适合处理远景区域的光照和反射。
   这可以显著提高渲染效率，避免远景区域的光照每帧都进行复杂的计算。

# Surface Caching 的优点

性能提升：
  通过缓存表面光照信息，能够减少复杂光照计算的频率，特别是在间接光和多次弹射光线的场景中。这样可以减轻 GPU 的负载，提升整体性能。
  
减少计算冗余：
  在实时渲染中，许多场景的光照信息在连续的帧之间变化不大。Surface Caching 通过保存和复用这些数据，避免了重复计算。

适应动态场景：
  Surface Caching 适用于动态变化的场景，缓存的数据可以在必要时更新，而不是每一帧都重新计算。通过智能的缓存管理，可以平衡光照质量和实时性。

# 技术挑战

缓存更新管理：
  动态场景中如何高效管理缓存更新是 Surface Caching 的一大挑战。若场景中光源、相机或物体频繁移动，缓存需要不断更新，可能会导致性能开销增加。
  
缓存精度：
  缓存的数据必须足够精确，以避免光照和反射细节丢失。特别是在处理复杂的反射或阴影时，如果缓存分辨率或质量不足，可能会产生视觉伪影或光照不连贯的问题。

内存开销：
  Surface Caching 需要额外的内存空间来存储光照缓存数据。在大型场景或高分辨率的场景中，缓存的大小会直接影响内存的占用，可能需要权衡缓存大小与内存消耗。

# 总结

Surface Caching 是一种实时渲染技术，用于在光照和全局光照（Global Illumination，简称 GI）中缓存表面上的光照数据，从而减少对复杂光照的重复计算，特别是针对间接光照、反射和全局光照效果的处理。它通过将场景表面上的光照信息存储并复用，在随后的渲染帧中可以显著提升性能。Surface Caching 涉及多个核心技术，主要用于加速和优化光照计算。

# Surface Caching 所包含的核心技术

1. 光照缓存（Lighting Caching）
   光照缓存是 Surface Caching 的核心部分，专门存储在物体表面上的光照信息。包括直接光、间接光、环境光遮蔽（Ambient Occlusion），以及其他与光线交互相关的数据。
   通过缓存表面光照信息，系统可以在后续帧中复用这些数据，避免每帧重新计算复杂的光照与反射，尤其是涉及多次反弹的间接光照。
   典型的缓存数据结构包括：
     反射和折射的颜色信息
     物体表面的法线数据和位置信息
     采样到的环境光或光源的贡献值

2. 动态更新与增量计算（Dynamic Update and Incremental Calculation）
   在动态场景中（例如物体移动、光源位置变化），Surface Caching 需要针对场景变化更新缓存。通常不会每帧全局更新，而是采用增量更新技术，确保只更新必要的表面光照数据。
   动态更新的机制依赖于场景变化的检测：当物体、光源或相机的位置发生显著变化时，Surface Cache 会部分失效，只更新这些变化影响到的部分。
   增量计算还可以通过渐进式的光照计算来平滑过渡，使得缓存的更新对帧率影响较小。

3. 层级光照缓存（Hierarchical Caching）
   在大型场景中，使用层级化的缓存结构可以有效管理光照数据。例如，可以根据物体距离、相机视角等因素来决定光照缓存的精度和存储细节。
   在远处的物体可以使用较低分辨率的缓存，而近处的物体则使用高分辨率缓存。通过这种层次化处理，减少了内存的开销和对性能的压力。
   层级缓存结构还可以利用类似于八叉树（Octree）或 BVH（Bounding Volume Hierarchy）等空间分割技术，提升光照数据的管理和存取效率。

4. 稀疏体积光照（Sparse Voxel Lighting）
   稀疏体积表示是一种将场景中的光照信息以稀疏的三维网格存储的技术。通过在表面附近的空间中采样光照信息，稀疏体积结构能够捕捉和缓存间接光照和反射数据。
   这是一种空间化缓存方法，将光照数据存储在特定的体积网格中，而不是单纯的二维表面纹理上。这样可以更好地处理复杂的间接光照，尤其是当物体之间有较多反射和遮挡时。

5. 反射和全局光照缓存（Reflections and Global Illumination Caching）
   对于复杂的反射和全局光照计算，Surface Caching 通过保存多次弹射光线的结果，减少每帧的计算负担。通常会结合 Screen Space Reflections (SSR) 或 Ray Traced Reflections (RTR) 来捕捉光线在物体上的反射。
   在反射计算中，缓存不仅包含直接的反射光线，还可能包含多次间接反射的光线路径数据，这对于复杂场景的逼真渲染非常关键。
   在 Lumen 中，Surface Caching 配合卡片追踪（Card Tracing）技术优化了全局光照计算，通过卡片化简化几何体，再结合 Surface Cache 存储的反射和间接光信息，加速了反射的复用。

6. 插值与混合（Interpolation and Blending）
   缓存中的光照信息并不是静态的，它需要随着场景的变化进行动态插值和混合。通过光照插值，可以在缓存数据之间平滑过渡，避免因缓存更新带来的视觉伪影（例如闪烁或跳变）。
   插值技术可以根据相机的位置、视角的变化以及场景的局部动态，实时调整表面的光照值，确保场景的光照变化是连续的。

7. 屏幕空间光照（Screen Space Lighting）
   Surface Caching 还可以与 屏幕空间技术 配合使用。在屏幕空间中，利用帧缓冲区保存的表面信息（如深度、法线、颜色等），可以快速计算并缓存光照效果。
   这种技术特别适合处理反射和局部光照，可以结合 Surface Caching 缓存结果，将间接光照和反射信息保存在屏幕空间缓存中，进一步提升性能。

# Surface Caching 的关键应用场景

1. 全局光照（Global Illumination，GI）：
   全局光照计算往往是渲染中的性能瓶颈，因为它需要考虑光线的多次反弹。Surface Caching 通过缓存全局光照的中间结果，避免了每帧重新计算光线弹射。
   特别是在像 Lumen 这样的系统中，Surface Caching 与卡片追踪（Card Tracing）等技术结合，进一步提升了全局光照计算的性能。

2. 反射和折射（Reflections and Refractions）：
   在复杂场景中，反射和折射光线的计算极其复杂，Surface Caching 可以缓存反射光线的结果，减少每帧重新追踪光线的次数。
   这在具有高光泽表面的场景中尤为重要，尤其是在动态光源或动态物体环境下，通过缓存反射结果可以显著提高实时渲染性能。

3. 间接光照（Indirect Lighting）：
   Surface Caching 对于间接光照的处理尤为关键。间接光照涉及光线的多次弹射，计算成本很高。通过 Surface Cache，可以在场景的表面缓存间接光照的结果，并在场景变化时进行局部更新。

Surface Caching 是一种用于优化光照计算的技术，能够缓存场景表面的光照和反射信息，减少对复杂光照效果的重复计算。这种技术特别适合于需要处理动态全局光照和反射的实时渲染场景，尤其在现代游戏引擎中广泛应用。它的主要优势是能够大幅提升渲染性能，同时在动态场景中保证光照效果的连续性。不过，Surface Caching 在缓存更新和内存管理上需要精心设计，以避免性能开销和视觉伪影的产生。