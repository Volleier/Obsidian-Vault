Lumen 是 Unreal Engine 5 引擎中的一种全局照明和反射系统，旨在提供实时的动态全局光照效果，替代传统的预烘焙照明方法。它使得场景中光线的传播、反射、折射等效果更加真实和灵活，特别适用于动态环境。Lumen 的架构复杂，包含多个重要组成部分和技术，主要包括以下内容：

全局光照（Global Illumination, GI）：
  Lumen 提供了动态全局光照系统，能够实时计算间接光照，而不需要预先烘焙光照贴图。
  支持光线的多次弹射，模拟光线在场景中物体之间的反射和扩散。
  可以自动适应动态光源和物体的变化，如开关灯、时间变化（如白天到黑夜的过渡），或物体移动。
  
屏幕空间反射（Screen Space Reflection, SSR）：
  Lumen 使用屏幕空间反射技术来计算物体表面上反射的环境光。
  这种方法利用当前屏幕上可见的信息进行反射计算，虽然效果实时，但反射范围受限于可见的屏幕区域，导致视角外的区域无法反射。

卡场追踪（Card Tracing）：
  Lumen 使用卡片（Card）来表示场景中的复杂几何体，并通过这些卡片简化全局光照的计算。
  卡片是基于场景的体积层次（Voxel-based）来生成的，能够高效地表示大规模场景中的光照信息。
  卡场追踪是一种更快的替代光线追踪的方法，用于处理大范围的光线反射和折射。

反向光线追踪（Ray Tracing）：
  Lumen 可以结合反向光线追踪来计算精确的反射和折射效果，尤其是对于屏幕外的光线。
  反向光线追踪用于处理SSR无法覆盖的区域，补充屏幕空间技术的不足。
  这种方法能显著提升反射质量，特别是处理镜面反射、金属材质和水面等高光泽表面时效果出众。

光线追踪距离场（Distance Field Ray Tracing）：
  使用距离场数据计算光线与场景几何体之间的相交情况，适合计算动态全局光照。
  距离场是一种用来表示场景几何体的三维数据结构，它能够有效地捕捉物体表面的轮廓和形状，帮助提高光线追踪计算的效率。

光子映射（Photon Mapping）：
  Lumen 在某些情况下使用类似光子映射的技术，通过将光能量分布到场景中的多个光子上，模拟间接光照。
  这种方法增强了全局光照的效果，尤其是在复杂的光照场景中，如光线通过狭窄空间的多次反射。

虚拟阴影贴图（Virtual Shadow Maps, VSM）：
  Lumen 支持虚拟阴影贴图，用于高效计算动态阴影。
  虚拟阴影贴图能够处理高细节场景中的复杂阴影，并支持软阴影和物体之间的阴影过渡。
  VSM 提高了阴影计算的精度，特别适合大型开放世界场景。

多分辨率体积全局光照（Multi-Bounce Voxelized Global Illumination）：
  Lumen 还使用多次弹射的体素全局光照技术，允许光线在不同物体和表面之间多次反射，模拟出更真实的光线传播效果。
  这种技术在保证性能的同时，能够生成逼真的间接光照和环境反射。

反射光捕捉（Reflection Capture）：
  Lumen 支持反射光捕捉球体技术，用于预估反射方向和环境光。
  通过这种捕捉方法，可以优化复杂场景中的反射计算，尤其是在细节较多的室内环境。

动态间接光照和反射（Dynamic Indirect Lighting and Reflections）：
  Lumen 允许光源和物体在场景中自由移动，并能实时更新全局光照和反射效果。
  无需重新烘焙光照，极大提高了开发效率，适用于开放世界、动态天气系统等。

Lumen 的设计旨在满足高品质的实时渲染需求，通过整合光线追踪、屏幕空间反射、卡片追踪等多种技术，使得它能够在不同硬件平台上表现出色。它提供了灵活的光照处理方法，既能在高端PC或主机上实现逼真的光线追踪效果，又能在移动设备上通过优化技术提供优秀的渲染质量。

Lumen 是 Unreal Engine 5 中用于实时全局光照（Global Illumination, GI）和反射的先进系统，其架构复杂，结合了多种技术和算法，旨在在不同硬件平台上平衡质量与性能。Lumen 的主要流程包括场景的全局光照和反射计算，动态更新以及光源和几何体变化时的实时响应。以下是 Lumen 的流程和用于 Lumen 的 GI 算法的主要内容：

# Lumen 工作流程

1. 场景初始化：
   引擎会对场景进行初步分析，生成几何体的表示（如距离场和卡片结构），并建立用于光照和反射计算的基础数据。
   使用体素（Voxel）或者距离场（Distance Field）表示物体的几何信息，生成近似的体积数据，用于全局光照计算。

2. 主光源的直接照明：
   Lumen 会先处理直接光源的照明，例如太阳光、灯光等。这一步通常由标准的光栅化技术处理，并生成初步的阴影和光照信息。
   Lumen 会基于虚拟阴影贴图（Virtual Shadow Maps, VSM）计算出场景中的阴影效果，为接下来的全局光照计算打好基础。

3. 屏幕空间全局光照（Screen Space Global Illumination, SSGI）：
   Lumen 使用屏幕空间全局光照技术来捕捉场景中可见区域的间接光照。该技术利用当前帧缓冲的颜色信息来计算全局光的第一次弹射。
   SSGI 的优势是实时高效，但受限于屏幕外的几何体信息。因此它通常与其他技术（如卡片追踪、反向光线追踪）配合使用，补足屏幕外区域的计算。

4. 卡片追踪（Card Tracing）：
   卡片追踪是 Lumen 的核心技术之一。它通过简化的几何表示（卡片）来跟踪光线的反射和折射，从而计算间接光照和反射效果。
   场景中的几何体会被简化成较粗糙的卡片结构，适合快速的光线追踪操作。这样可以加快计算速度，同时保持较高的光照质量。

5. 光线追踪反射与全局光照（Ray Traced Reflections and Global Illumination）：
   为了处理屏幕空间无法覆盖的反射区域，Lumen 使用了反向光线追踪。它能够捕捉视野外的几何体，生成精确的镜面反射和间接光照效果。
   在某些高质量模式下，Lumen 还可以使用基于 GPU 的硬件加速光线追踪，处理更复杂的光线交互，如多次反射、折射等。

6. 多次弹射的体素全局光照（Multi-Bounce Voxelized Global Illumination）：
   Lumen 使用体素化的场景表示来计算光线的多次弹射。体素化（Voxelization）是一种将场景中的几何体简化为三维网格的方法，能够高效表示复杂的几何结构。
   在计算光线的多次弹射时，体素全局光照能够模拟光线在场景中不同表面之间的扩散和反射，增强间接光照的效果。

7. 动态光照更新：
   Lumen 能够实时更新场景中的全局光照和反射效果，这意味着光源位置变化、几何体移动或环境变化时，Lumen 都会自动调整光照信息。
   例如，在开放世界游戏中，当时间从白天变为黑夜时，Lumen 会自动调整全局光照和反射，以适应变化。

8. 后处理和反射捕捉：
   Lumen 还支持反射捕捉技术，尤其适合室内场景中复杂的环境光反射。
   最终的光照和反射效果会通过后处理进行优化，包括抗锯齿、模糊反射以及其他图形效果，提升整体视觉质量。

# Lumen 使用的 GI 算法

1. 屏幕空间全局光照（Screen Space Global Illumination, SSGI）：
   基于屏幕空间的实时光照技术，能够通过读取屏幕上的信息来计算全局光。
   SSGI 只考虑屏幕上可见的部分，计算快速但有局限性，无法处理屏幕外的光线反射。

2. 卡片追踪（Card Tracing）：
   将场景几何体简化为二维卡片来加速光线追踪的计算。卡片是场景几何体的一种简化表示，用来处理粗略的光照反射和折射。
   这种方法相比完整的几何体光线追踪要高效得多，适合大规模场景中的光照计算。

3. 体素全局光照（Voxelized Global Illumination）：
   体素化技术将场景中的几何体简化为体素（Voxel），然后对这些体素进行多次弹射光照的计算。
   这种方法能够处理大规模的全局光照，并能通过低分辨率体素近似高分辨率几何体，降低计算开销。

4. 距离场光照（Distance Field GI）：
   使用距离场来表示场景中的几何体，通过计算光线与距离场之间的交互来生成全局光照。
   距离场是一种能够高效处理复杂几何体的三维结构，可以快速计算光线追踪中的相交操作。

5. 反向光线追踪（Ray Tracing）：
   Lumen 可以选择使用传统的反向光线追踪来处理屏幕外的全局光照和反射。
   这种方法计算准确，特别适合高反射性表面和复杂光线弹射，但性能开销较大，通常与其他技术混合使用。

6. 混合光照模式（Hybrid GI）：
   Lumen 结合多种算法，如屏幕空间光照、卡片追踪、体素化光照等，以平衡性能和视觉质量。
   这种混合模式能够根据场景的需求动态选择最合适的算法，确保不同硬件平台上的性能表现。

通过这些技术和流程，Lumen 实现了实时的动态全局光照和反射，使得开发者能够在复杂的动态场景中实现高质量的光照效果，而无需烘焙贴图或预处理光照数据。这为开放世界游戏、动态环境场景、以及高端实时渲染带来了巨大的灵活性。