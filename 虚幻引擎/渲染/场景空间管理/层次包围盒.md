层次包围盒（Bounding Volume Hierarchy，BVH）是一种广泛用于计算机图形学中的数据结构，用于加速各种空间查询操作，如碰撞检测、光线追踪和可见性测试。BVH通过递归地将场景中的对象包围在更大的包围盒中，形成一个层次结构，从而可以快速地进行空间查询和计算。

# 基本概念

1. 包围盒（Bounding Volume）:
   - 一个简单的几何体（如轴对齐包围盒（Axis-Aligned Bounding Box, AABB）、球体、凸包等），可以完全包含一个对象或一组对象。
   - 选择包围盒时，常用的是轴对齐包围盒，因为它的计算简单且效率高。

2. 层次结构:
   - BVH是一种树形结构，其中每个节点包含一个包围盒。
   - 内部节点（非叶节点）包含一个包围盒，它完全包含其子节点的所有包围盒。
   - 叶节点包含实际的对象或一组对象。

# 构建

1. 初始化:
   - 从场景中的所有对象开始，每个对象都有一个初始的包围盒。

2. 递归分割:
   - 将对象集分成两个子集，并为每个子集创建一个包围盒。
   - 继续递归地分割每个子集，直到达到某个停止条件（如每个子集中的对象数量少于一个阈值，或者树的深度达到一个上限）。

3. 包围盒计算:
   - 对于每个节点，根据其子节点的包围盒计算一个新的包围盒，这个包围盒完全包含其所有子节点的包围盒。

# 查询

1. 碰撞检测:
   - 从BVH的根节点开始，与目标对象的包围盒进行碰撞测试。
   - 如果根节点的包围盒与目标对象的包围盒不相交，则整个树都不需要进一步测试。
   - 如果相交，则递归地测试子节点，直到找到相交的叶节点（实际的对象）。

2. 光线追踪:
   - 从BVH的根节点开始，进行光线与包围盒的相交测试。
   - 如果光线不与当前包围盒相交，则跳过当前节点及其子节点。
   - 如果相交，则递归地测试子节点，直到找到与光线相交的叶节点（实际的对象）。

3. 可见性测试:
   - 类似于碰撞检测，通过BVH结构快速确定哪些对象在视锥体内，从而减少不必要的渲染。

# 优点和缺点

优点:
- 加速查询: 通过层次结构，可以快速排除大部分不相关的对象，只对相关对象进行详细计算。
- 适应动态场景: 适用于需要频繁更新的场景，可以通过局部更新来维护BVH。
- 灵活性: 可以选择不同类型的包围盒，根据具体应用场景优化性能。

缺点:
- 构建复杂: BVH的构建和维护可能比较复杂，特别是在对象频繁移动或变化的场景中。
- 平衡性问题: 如果对象分布不均匀，可能导致BVH不平衡，从而影响查询性能。

# 应用场景

1. 实时渲染: 在游戏和虚拟现实中，通过BVH进行快速的碰撞检测和可见性测试，提高渲染效率。
2. 物理模拟: 用于物理引擎中的碰撞检测和响应，加速模拟计算。
3. 光线追踪: 在光线追踪算法中，通过BVH加速光线与场景的相交测试，提高渲染速度。