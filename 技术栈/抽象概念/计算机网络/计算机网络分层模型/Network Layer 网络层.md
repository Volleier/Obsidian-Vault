# 网络层概览
**网络层**（**N**etwork **L**ayer）是[[OSI七层模型|OSI模型]]中的第三层（[TCP/IP](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F "TCP/IP协议族")模型中的网际层），提供[路由](https://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1 "路由")和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。相当于发送邮件时需要地址一般重要。由于TCP/IP协议体系中的网络层功能由IP协议规定和实现，故又称IP层。

# IPV4协议
## IPv4 分组

### 分组结构**
IPv4 分组由 **20~60字节的首部**和**最大65515字节的数据部分**组成。首部固定部分（20字节）包含核心控制字段，可变部分（0~40字节）用于扩展功能。

关键字段协同工作：
- 版本（4bit）标识IPv4/v6；
- 首部长度（4bit，×4B单位）决定首部大小（20~60B）；
- 总长度（16bit，×1B单位）定义分组总字节数；
- 标识+标志+片偏移 共同管理分片机制；
- TTL 控制分组生命周期，协议字段指示上层协议类型（如TCP/UDP）。

首部校验和仅校验首部，算法与UDP一致，校验失败则丢弃分组。

### 分片机制（MTU约束）

当分组长度超过下一跳链路 MTU（如以太网1500B）时，路由器或源主机触发分片：
1. 分片规则
    - 分片仅在终点主机重组，中途不重组
    - 每个分片均为独立IP分组（含完整首部）
    - 非末片数据长度必须为8B整数倍（因片偏移以8B为单位）
2. 字段协作
    - 标识符相同 → 标记同属原始分组
    - MF位：1=后续有分片，0=末片
    - DF位：1=禁止分片（触发ICMP错误）
    - 片偏移 = 原始数据位置 / 8

实例：3980B数据（MTU=1500B）
- 分片1：1480B数据（偏移0，MF=1）
- 分片2：1480B数据（偏移185×8=1480B，MF=1）
- 分片3：1020B数据（偏移370×8=2960B，MF=0）

### TTL与ICMP控制环
TTL（生存时间） 由源主机设置初始值（常为64/128），每经路由器减1：
- TTL=0 → 丢弃分组 + 向源端发送 ICMP超时报文（Type 11）
- ICMP 同步传递其他异常（如目的不可达、参数错误等）
此机制本质是网络层的故障熔断策略，防止分组因路由环路无限滞留。

### 核心计算与易错点

| 字段    | 计算规则                | 实例              |
| ----- | ------------------- | --------------- |
| 首部长度  | 值×4B                | 5 → 20B         |
| 总长度   | 直接字节数               | 1500 → 1500B    |
| 片偏移   | 值×8B = 原始数据位置       | 185 → 1480B位置   |
| 分片数据长 | 非末片需满足 长度 mod 8 = 0 | 1480B合规，1482B错误 |

注意：
1. 分片时仅复制原始首部，但更新标志/片偏移；
2. TTL归零时当前路由器负责发送ICMP，非终点；
3. 数据长度 = 总长度 - 首部长度（如总长48B、首部20B → 数据28B）。

## IPV4地址与NAT


## 子网划分与子网掩码
### 子网划分原理与作用
子网划分通过借用主机号高位比特作为子网号，将单一IP网络划分为多个逻辑子网。假设原主机号占 $n$ 位，借用前 $k$ 位作子网号，剩余 $n−k$ 位为主机号，可划分 $2^k$ 个子网（每个子网IP地址块大小相等）。
- 技术本质：提升IP地址利用率，优化网络管理（如隔离广播域）。
- 配置要求：
    - 子网内所有主机需配置 IP地址、子网掩码、默认网关。
    - 支持子网的路由器转发表需包含 目的网络号、子网掩码、转发接口。
- 默认子网掩码：
    - A类：`255.0.0.0`，B类：`255.255.0.0`，C类：`255.255.255.0`

### 主机发送IP数据报的流程
子网掩码是判断网络归属的核心工具，决定了数据报的下一跳方向
1. **判断同网段**：
    - 用本机**子网掩码**与**目的IP**逐位相与，结果与本机**网络前缀**比对。
    - **相同**：目的主机在同一网络，通过ARP获取目的MAC地址，直接封装帧发送。
    - **不同**：目的主机在外部网络，通过ARP获取**默认网关MAC地址**，封装帧发送至网关。

### 路由器转发IP数据报的流程
1. 校验与提取：校验首部，提取目的IP地址。
2. 查转发表：
    - 将目的IP与每条表项的子网掩码逐位相与，匹配目的网络号。
    - 遵循最长前缀匹配原则（如`166.1.128.0/17`优先于`166.1.0.0/16`）。
3. 转发决策：
    - 匹配成功：从对应接口转发（若入口=出口则丢弃，避免环路）。
    - 无匹配：走默认路由（目的网络号`0.0.0.0`，子网掩码`0.0.0.0`）。

注：路由器不重组分片，不修改IP源/目的地址（NAT除外）。

### 典型场景训练解析

**拓扑背景**：
- 学校网络：B类地址`166.1.x.x`，子网掩码`255.255.128.0`（`/17`），划分为2子网：
    
    - 子网0：`166.1.0.0/17`（主机H1~H2，网关`166.1.0.5`）
        
    - 子网1：`166.1.128.0/17`（主机H3~H6，网关`166.1.128.1`）
        
- 公司网络：C类地址`200.1.1.0/24`（主机H7~H8，网关`200.1.1.1`）。
    

|**训练场景**|**关键步骤**|
|---|---|
|**H3→H6（同子网）**|1. H3用掩码`255.255.128.0`判断H6在同一子网  <br>2. ARP获取H6 MAC，直发数据报|
|**H1→H3（跨子网）**|1. H1判断H3在不同子网  <br>2. ARP获取网关`166.1.0.5`的MAC  <br>3. 路由器查表转至子网1接口|
|**H1→H7（校→公）**|1. 学校路由器匹配`200.1.1.0/24`，转至ISP  <br>2. ISP路由转至公司网关|
|**H7→H1（公→校）**|1. ISP路由匹配`166.1.0.0/17`，转至学校网关  <br>2. 学校路由查表转至子网0|
|**H1→Internet**|1. 学校路由器无匹配，走默认路由`0.0.0.0/0`至ISP  <br>2. ISP路由转发至外部网络|

---

#### **五、CIDR与子网掩码进阶**

- **CIDR表示法**：`IP地址/前缀长度`（如`166.1.128.0/17`），替代传统子网掩码，支持路由聚合。
    
- **多级子网划分**：
    
    - 例：B类地址`166.1.x.x`借2位子网号（`k=2`），划分4个子网：
        
        - 子网0：`166.1.0.0/18`，掩码`255.255.192.0`
            
        - 子网1：`166.1.64.0/18`
            
        - 子网2：`166.1.128.0/18`
            
        - 子网3：`166.1.192.0/18`
            
    - 主机号剩余14位，每个子网支持 214−2214−2 个主机地址。
        

> **路由表优化**：使用CIDR可合并连续网络（如`166.1.0.0/16`覆盖所有子网），减少转发表项。

## CIDR、路由聚合、ARP、DHCP

# IPV6协议


# 网络层辅助协议


# 路由技术


# 高级网络层技术
