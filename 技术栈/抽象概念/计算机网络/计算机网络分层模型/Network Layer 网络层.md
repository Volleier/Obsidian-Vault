# 网络层概览
**网络层**（**N**etwork **L**ayer）是[[OSI七层模型|OSI模型]]中的第三层（[TCP/IP](https://zh.wikipedia.org/wiki/TCP/IP%E5%8D%8F%E8%AE%AE%E6%97%8F "TCP/IP协议族")模型中的网际层），提供[路由](https://zh.wikipedia.org/wiki/%E8%B7%AF%E7%94%B1 "路由")和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。相当于发送邮件时需要地址一般重要。由于TCP/IP协议体系中的网络层功能由IP协议规定和实现，故又称IP层。

# IPV4协议
## IPv4 分组

### 分组结构
IPv4 分组由 **20~60字节的首部**和**最大65515字节的数据部分**组成。首部固定部分（20字节）包含核心控制字段，可变部分（0~40字节）用于扩展功能。

关键字段协同工作：
- 版本（4bit）标识IPv4/v6；
- 首部长度（4bit，×4B单位）决定首部大小（20~60B）；
- 总长度（16bit，×1B单位）定义分组总字节数；
- 标识+标志+片偏移 共同管理分片机制；
- TTL 控制分组生命周期，协议字段指示上层协议类型（如TCP/UDP）。

首部校验和仅校验首部，算法与UDP一致，校验失败则丢弃分组。

### 分片机制（MTU约束）

当分组长度超过下一跳链路 MTU（如以太网1500B）时，路由器或源主机触发分片：
1. 分片规则
    - 分片仅在终点主机重组，中途不重组
    - 每个分片均为独立IP分组（含完整首部）
    - 非末片数据长度必须为8B整数倍（因片偏移以8B为单位）
2. 字段协作
    - 标识符相同 → 标记同属原始分组
    - MF位：1=后续有分片，0=末片
    - DF位：1=禁止分片（触发ICMP错误）
    - 片偏移 = 原始数据位置 / 8

实例：3980B数据（MTU=1500B）
- 分片1：1480B数据（偏移0，MF=1）
- 分片2：1480B数据（偏移185×8=1480B，MF=1）
- 分片3：1020B数据（偏移370×8=2960B，MF=0）

### TTL与ICMP控制环
TTL（生存时间） 由源主机设置初始值（常为64/128），每经路由器减1：
- TTL=0 → 丢弃分组 + 向源端发送 ICMP超时报文（Type 11）
- ICMP 同步传递其他异常（如目的不可达、参数错误等）
此机制本质是网络层的故障熔断策略，防止分组因路由环路无限滞留。

### 核心计算与易错点

| 字段    | 计算规则                | 实例              |
| ----- | ------------------- | --------------- |
| 首部长度  | 值×4B                | 5 → 20B         |
| 总长度   | 直接字节数               | 1500 → 1500B    |
| 片偏移   | 值×8B = 原始数据位置       | 185 → 1480B位置   |
| 分片数据长 | 非末片需满足 长度 mod 8 = 0 | 1480B合规，1482B错误 |

注意：
1. 分片时仅复制原始首部，但更新标志/片偏移；
2. TTL归零时当前路由器负责发送ICMP，非终点；
3. 数据长度 = 总长度 - 首部长度（如总长48B、首部20B → 数据28B）。

## IPV4地址与NAT


## 子网划分与子网掩码
### 子网划分原理与作用
子网划分通过借用主机号高位比特作为子网号，将单一IP网络划分为多个逻辑子网。假设原主机号占 $n$ 位，借用前 $k$ 位作子网号，剩余 $n−k$ 位为主机号，可划分 $2^k$ 个子网（每个子网IP地址块大小相等）。
- 技术本质：提升IP地址利用率，优化网络管理（如隔离广播域）。
- 配置要求：
    - 子网内所有主机需配置 IP地址、子网掩码、默认网关。
    - 支持子网的路由器转发表需包含 目的网络号、子网掩码、转发接口。
- 默认子网掩码：
    - A类：`255.0.0.0`，B类：`255.255.0.0`，C类：`255.255.255.0`
- 子网划分公式

- 子网数 = 2k2k（kk = 子网号位数）
    
- 每子网可用地址数 = 2(n−k)−22(n−k)−2（nn = 原主机号位数）
### 主机发送IP数据报的流程
子网掩码是判断网络归属的核心工具，决定了数据报的下一跳方向
1. **判断同网段**：
    - 用本机**子网掩码**与**目的IP**逐位相与，结果与本机**网络前缀**比对。
    - **相同**：目的主机在同一网络，通过ARP获取目的MAC地址，直接封装帧发送。
    - **不同**：目的主机在外部网络，通过ARP获取**默认网关MAC地址**，封装帧发送至网关。

### 路由器转发IP数据报的流程
1. 校验与提取：校验首部，提取目的IP地址。
2. 查转发表：
    - 将目的IP与每条表项的子网掩码逐位相与，匹配目的网络号。
    - 遵循最长前缀匹配原则（如`166.1.128.0/17`优先于`166.1.0.0/16`）。
3. 转发决策：
    - 匹配成功：从对应接口转发（若入口=出口则丢弃，避免环路）。
    - 无匹配：走默认路由（目的网络号`0.0.0.0`，子网掩码`0.0.0.0`）。

注：路由器不重组分片，不修改IP源/目的地址（NAT除外）。

### 典型场景训练解析

**拓扑背景**：
- 学校网络：B类地址`166.1.x.x`，子网掩码`255.255.128.0`（`/17`），划分为2子网：
    - 子网0：`166.1.0.0/17`（主机H1~H2，网关`166.1.0.5`）
    - 子网1：`166.1.128.0/17`（主机H3~H6，网关`166.1.128.1`）
- 公司网络：C类地址`200.1.1.0/24`（主机H7~H8，网关`200.1.1.1`）。

| 训练场景        | 关键步骤                                                               |
| ----------- | ------------------------------------------------------------------ |
| H3→H6（同子网）  | 1. H3用掩码`255.255.128.0`判断H6在同一子网  <br>2. ARP获取H6 MAC，直发数据报         |
| H1→H3（跨子网）  | 1. H1判断H3在不同子网  <br>2. ARP获取网关`166.1.0.5`的MAC  <br>3. 路由器查表转至子网1接口 |
| H1→H7（校→公）  | 1. 学校路由器匹配`200.1.1.0/24`，转至ISP  <br>2. ISP路由转至公司网关                 |
| H7→H1（公→校）  | 1. ISP路由匹配`166.1.0.0/17`，转至学校网关  <br>2. 学校路由查表转至子网0                |
| H1→Internet | 1. 学校路由器无匹配，走默认路由`0.0.0.0/0`至ISP  <br>2. ISP路由转发至外部网络              |

### CIDR与子网掩码进阶
- CIDR表示法：`IP地址/前缀长度`（如`166.1.128.0/17`），替代传统子网掩码，支持路由聚合。
- 多级子网划分：
    - 例：B类地址`166.1.x.x`借2位子网号（`k=2`），划分4个子网：
        - 子网0：`166.1.0.0/18`，掩码`255.255.192.0`
        - 子网1：`166.1.64.0/18`
        - 子网2：`166.1.128.0/18`
        - 子网3：`166.1.192.0/18`
    - 主机号剩余14位，每个子网支持 214−2214−2 个主机地址。
路由表优化：使用CIDR可合并连续网络（如`166.1.0.0/16`覆盖所有子网），减少转发表项。

## CIDR、路由聚合、ARP、DHCP
## CIDR
因为传统 IP 地址分类（A/B/C/D/E）存在地址浪费、灵活性差等严重缺陷。诞生出CIDR 解决方案：
- 取消分类边界：IP 地址 = 网络前缀（可变长） + 主机号。
- 地址块表示法：`起始IP/前缀长度`（如 `128.14.32.0/21`）。
- 核心优势：按需分配任意大小地址块，提升利用率。
### CIDR 子网划分技术

### 定长子网划分
- 规则：从主机号借用固定 $k$ 位作子网号，生成 $2^k$ 个等大子网。
- 公式：
    - 子网数 = $2^k$
    - 每子网可用 IP 数 = $2^{(n-k)} - 2$（$n$=原主机号位数，减 2 排除全 0/全 1 地址）。

### 变长子网划分
- 规则：子网号长度可变，允许不同大小的子网共存。
- 应用场景：按需分配地址（如小办公室用小子网，数据中心用大子网）。
- 实现技巧：二叉哈夫曼树模型：
    - 根节点：原始 CIDR 块（如主机号占 $h$ 位）。
    - 分裂规则：左子树赋 0，右子树赋 1（深度决定子网前缀长度）。
    - 叶子节点：最终子网，深度需 ≤ $h-1$（最小子网保留 ≥2 位主机号）。

### CIDR 核心机制与约束
1. 主机号全 0/全 1 禁用：
    - 全 0 为网络地址，全 1 为广播地址，均不可分配设备。
2. 最小子网约束：
    - 点对点链路需至少 `/30` 子网（主机号 2 位，提供 2 可用 IP）。
    - 原因：单主机位（如 `/31`）无可用 IP（仅剩全 0/全 1）。
3. 路由聚合（超网）：
    - 合并连续子网缩短前缀（如 `166.1.0.0/18`+`166.1.64.0/18` → `166.1.0.0/16`）。
    - **优势**：大幅压缩路由表规模。

# IPV6协议
IPv6（Internet Protocol version 6）是下一代互联网协议，旨在解决 IPv4 地址耗尽问题，同时改进数据报处理效率和支持现代网络需求。IPv6 采用 128 位地址空间，提供了更大的地址容量，并优化了首部格式，支持快速处理和转发数据报。此外，IPv6 引入了流标签、扩展首部等新特性，支持服务质量（QoS）和即插即用功能。

## IPv6 的产生原因
IPv6 的诞生主要是为了解决 IPv4 地址空间不足的问题。32 位的 IPv4 地址空间已经分配殆尽，尽管通过 CIDR（无类别域间路由）和 NAT（网络地址转换）等技术暂时缓解了地址短缺问题，但这些方法只是权宜之计。IPv6 从根本上扩展了地址空间，同时改进了协议设计，提升了网络性能和安全性。

### 关键点
- IPv4 地址空间不足，IPv6 提供 128 位地址（约 3.4×10³⁸ 个地址）。
- IPv6 取消了 IPv4 中的校验和字段，简化了首部处理。
- 支持 QoS，优化网络延迟和阻塞问题。

## IPv6 数据报格式
IPv6 数据报由基本首部和有效载荷两部分组成。基本首部固定为 40 字节，简化了字段设计，提高了路由器的处理效率。有效载荷部分可以包含扩展首部和数据，长度不超过 65535 字节。

### 基本首部字段
1. 版本（4 位）：标识协议版本，固定为 6。
2. 优先级（8 位）：区分数据报的类别和优先级。
3. 流标签（20 位）：标识同一流的数据报，用于 QoS。
4. 有效载荷长度（16 位）：指示有效载荷的大小。
5. 下一个首部（8 位）：标识下一个扩展首部或上层协议。
6. 跳数限制（8 位）：类似 IPv4 的 TTL，防止数据报无限循环。
7. 源地址和目的地址（各 128 位）：标识发送方和接收方。

### 特点
- 路由器不对扩展首部进行检查，提高处理效率。
- 分片仅在主机进行，简化了路由器操作。

## IPv6 与 IPv4 的区别
IPv6 在设计上对 IPv4 进行了多项改进，以下是主要区别：
1. 地址空间：IPv6 地址从 32 位扩展到 128 位。
2. 首部简化：移除校验和字段，将可选字段改为扩展首部。
3. 分片机制：IPv6 只能在主机处分片，IPv4 可在路由器和主机处分片。
4. 即插即用：IPv6 支持自动配置，无需 DHCP。
5. QoS 支持：通过流标签实现资源预分配和优先级管理。
6. 首部对齐：IPv6 首部为 8 字节整数倍，IPv4 为 4 字节整数倍。
7. ICMPv6：新增“分组过大”等报文类型。

## IPv6 地址表示形式
IPv6 地址采用冒号十六进制记法，长度为 128 位，通常分为 8 组，每组 4 个十六进制数字。
### 表示方法
1. 一般形式：  
    `4BF5:A412:0216:FEBC:BA5F:039A:BE9A:2170`
2. 压缩形式：  
    连续为零的组可以用 `::` 代替，但只能使用一次。  
    例如：`FF05:0:0:0:0:0:0:B3` 压缩为 `FF05::B3`。

### 规则：
- 每组前导零可省略，如 `039A` 可写为 `39A`。
- 双冒号 `::` 表示连续的零组。

## IPv6 基本地址类型
IPv6 定义了三种基本地址类型，用于不同通信场景：
1. 单播（Unicast）：  
    一对一通信，可作为源地址和目的地址。
2. 多播（Multicast）：  
    一对多通信，仅作为目的地址。
3. 任播（Anycast）：  
    一对多中最近的一个通信，仅作为目的地址。

## IPv6 向 IPv4 过渡的策略
由于 IPv6 和 IPv4 不兼容，过渡阶段需要采用以下技术实现平滑迁移：
1. 双栈协议（Dual Stack）：  
    设备同时运行 IPv4 和 IPv6 协议栈，支持两种地址的通信。
2. 隧道技术（Tunneling）：  
    将 IPv6 数据包封装在 IPv4 数据包中，通过 IPv4 网络传输，到达目的地后再解封装。
### 示意图
```text
IPv6 网络 → IPv4 网络 → IPv6 网络  
（封装）    （传输）    （解封装）
```


# 网络层辅助协议

## 动态主机配置协议 DHCP

## 网络地址转换 NAT

## 地址解析协议 ARP

# 路由技术
## 路由算法与路由协议


# 高级网络层技术

## IP多播


## 移动IP